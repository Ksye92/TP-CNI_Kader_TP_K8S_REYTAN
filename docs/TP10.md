## Filtrage flux L7

1.Créer le NS red
```shell
kubectl create ns red
```

2.Creer un pod basé sur l'image stefanprodan/podinfo dans le NS red
```shell
kubectl run -it --rm --restart=Never --image=stefanprodan/podinfo --namespace=red podinfo
```

3.Vérifier que vous pouvez désactiver un Pod en faisant un POST sur /readyz/disable (fonctionnalité de l'appli podinfo)
```shell
kubectl exec -it --rm --restart=Never --image=nicolaka/netshoot --namespace=red debug
# curl -X POST http://podinfo.red.svc/readyz/disable
```

4.Créer et appliquer une règle sur le pod poinfo pour empecher le POST sur /readyz/disable mais laisser le GET /readyz accessible.
La documentation est accessible ici : https://docs.cilium.io/en/v1.12/policy/language/#layer-7-examples
Voici un exemple A ADAPTER :

```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "rule1"
spec:
  description: "Allow HTTP GET /public from env=prod to app=service"
  endpointSelector:
    matchLabels:
      app: service
  ingress:
  - fromEndpoints:
    - matchLabels:
        env: prod
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/public"
```


Pour cela utilisez une règle CiliumNetwork Policy L7

5.Inspecter les Headers HTTP (curl -sv) avant et après l'apllication de la règle.
En déuire le composant logiciel qui bloque les appels L7.

[Revenir au sommaire](../README.md) | [TP Suivant](./TP11.md)