# Le reseau vu depuis les Pods

## Sommaire
  * [But de l'exercice](#but-du-tp)
  * [Deployer un DaemonSet](#deployer-un-daemonset)
  * [Attacher un shell dans un Pod](#attacher-un-shell-dans-un-pod)
  * [Résolution DNS d'un service interne](#résolution-dns-dun-service-interne)
  * [Connectivité réseau intra-cluster](#connectivité-réseau-intra-cluster)
  * [Cleanup](#cleanup)


## But du TP
* Apprendre à attacher un shell dans un Pod
* Faire des résolutions DNS depuis le Pod
* Faire des tests de connectivité TCP intra-cluster

## Deployer un DaemonSet

Déployer un DaemonSet à des fins de debug
```shell
kubectl apply -f ds-tshoot.yml
```
Pour notre information, voici le contenu de ce fichier :
```yaml
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ds-netshoot
spec:
  selector:
    matchLabels:
      run: netshoot
  template:
    metadata:
      labels:
        run: netshoot
    spec:
      containers:
      - name: netshoot
        image: nicolaka/netshoot
        tty: true
        stdin: true
        stdinOnce: true
```

Vérifier que les pods sont bien créés et affectés à chaque noeud
```shell
kubectl get ds -o wide
kubectl get pods -o wide
```

## Attacher un shell dans un pod

Creez un shell à l'intérieur un pod (remplacer xxxx par une valeur correcte):
```shell
kubectl exec -it ds-netshoot-xxxxx -- /bin/bash
```

Il existe même une autre façon dans le cas d'un DaemonSet, plus simple (pas besoin de connaître le nom du Pod), mais pouvoir influer sur le choix du Pod :

```shell
kubectl exec -it ds/ds-netshoot -- /bin/bash
bash-5.1# hostname
ds-netshoot-j752c
```

## Résolution DNS d'un service interne

Depuis le Pod, vérifier que le DNS fonctionne pour les noms de service
```shell
host hello-world.default.svc.cluster.local
```
Bien sûr "default" fait ici référence au namespace dans le quel se trouve le service de destination.

## Connectivité réseau intra-cluster

Remarquez que le ping des svc ClusterIP ne donne rien... **Pourquoi ?**
```shell
ping hello-world.default.svc.cluster.local
```
L'accès applicatif est lui fonctionnel
```shell
curl hello-world.default.svc.cluster.local
```

Vérifier qu'on peut bien pinguer les autres pods par IP :
```shell
ping <IP_POD>
```
Faire une requete web sur un des Pods
```shell
curl <IP_POD>:9898
```

Enfin, on remarquera que les plages d'IP des Pods sont disctinctes par Node, et également distincte de la plage des svc ClusterIP. C'est un choix d'implémention fréquent.

## Cleanup

```shell
kubectl delete svc hello-world
kubectl delete deployment hello-world
```

---

[Revenir au sommaire](../README.md) | [TP suivant](./TP04.md)