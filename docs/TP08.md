## Egress Network Policy

## Sommaire
  * [But de l'exercice](#but)
  * [Concevoir et Rédiger une  Network Policy Egress](#but)
  * [Appliquer la NetPol](#but)
  * [Vérification](#but)
  * [Nettoyer](#but)


## But du TP
* Rédiger une  Network Policy Egress
* L'appliquer et tester

Dans le NS blue, créer et appliquer une Egress NetPol qui empeche l'accès 23.23.23.23 en HTTP mais qui permette les autres flux.

Vous pouvez vous *inspirer* du template ci dessous : n'oubliez pas 
* que l'accès DNS (quels protocoles ? ports ?) doit continuer à fonctionner pour les Pods
* que tous les flux doivent être whitelistés dès qu'une 1ère régle s'applique à un Pod donné
* que l'action DENY n'existe pas (on le construit en faisant un ALLOW vers un CIDR en précisant une exception)

```yaml
---
### np-egress.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: internet-egress
spec:
  podSelector:
    matchLabels:
      app: foo
  policyTypes:
  - Egress
  egress:
    - to:
      - ipBlock:
          cidr: 0.0.0.0/0
          except:
            - 23.23.23.23/32
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
---
### np-egress.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dns-egress
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
    - to:
      - namespaceSelector:
         matchLabels:
          kubernetes.io/metadata.name: kube-system  
      ports:
        - protocol: TCP
          port: 53
        - protocol: TCP
          port: 53
```

L'appliquer dans le NS blue
```shell
kubectl apply -f np-egress.yaml -n blue
```

Tester dans le Pod debug-blue crée dans les précedents TPs :
```shell
debug-blue# curl http://23.23.23.23
debug-blue# curl https://1.1.1.1
debug-blue# curl http://1.1.1.1
debug-blue# host toto.com
```


## Cleanup : retirons la NP
```shell
kubectl delete -f np-egress.yaml -n blue
```

[Revenir au sommaire](../README.md) | [TP Suivant](./TP09.md)