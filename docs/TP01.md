# Setup initial

## Sommaire
  * [But de l'exercice](#but-du-tp)
  * [Installer `kubectl`](#installer-kubectl)
  * [Installer `kubectx` et `kubens`](#installer-kubectx-et-kubens)
  * [Installer `cilium-cli`](#installer-cilium-cli)
  * [Configurer le kubeconfig](#récupérer-et-installer-le-fichier-kubeconfig)
  * [Vérifier que l'accès `kubectl` fonctionne](#vérifier-que-laccès-kubectl-fonctionne)
  * [Accès aux Nodes](#accès-aux-nodes)
  * [Statut de Cilium CNI](#statut-de-cilium-cni-dans-le-cluster)
  * [Créer un compte GitHub et GitPod](#créer-un-compte-github-et-gitpod)
  * [Installer `stern` (sur Linux)](#installer-stern-sur-linux)

## But du TP
* Se familiariser et installer les outils nécessaires.
* Valider la configuration d'accès au cluster kubernetes individuel. 

## Installer `kubectl`
[kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) est l'outil de ligne de commande pour interagir avec un cluster kubernetes.

Si vous utilisez Windows, voici un [lien direct de téléchargement](https://dl.k8s.io/release/v1.25.0/bin/windows/amd64/kubectl.exe).

```shell
kubectl version --client
```

## Installer `kubectx` et `kubens`

Télécharger la version souhaitée sur ce lien : https://github.com/ahmetb/kubectx/releases

Si vous utilisez Windows voici les liens de téléchargemùent direct pour
* [`kubens`](https://github.com/ahmetb/kubectx/releases/download/v0.9.4/kubens_v0.9.4_windows_x86_64.zip)
* [`kubectx`](https://github.com/ahmetb/kubectx/releases/download/v0.9.4/kubectx_v0.9.4_windows_x86_64.zip)

`kubectx` permet de changer rapidement de contexte kubernetes si vous administrez plusieurs clusters.

```shell
kubectx
```

De son coté, `kubens` sert à changer rapidement de namespace, évitant ainsi à spécifier le paramètre `-n` à chaque invocation de `kubectl`.

```shell
kubens
```

## Installer `cilium-cli`

La partie "serveur" de Cilium sera pré-installée sur votre Cluster.

Pour installer le Command Line Interface (CLI) de Cilium sur votre *PC Windows*, suivre les instructions sur le [site de Cilium](https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#install-cilium-cli). Pour plus facilité, voici le [lien direct de téléchargement du binaire pour Windows x64](https://github.com/cilium/cilium-cli/releases/download/v0.12.3/cilium-windows-amd64.tar.gz).

Pour installer le CLI sur *linux*, suivez les instructions suivantes:

```bash
export CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)
export CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/$CILIUM_CLI_VERSION/cilium-linux-$CLI_ARCH.tar.gz
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz
```

Pour installer le LCI sur *Mac*, suivez les instructions suivantes:

```bash
export CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)
export CLI_ARCH=amd64
if [ "$(uname -m)" = "arm64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/$CILIUM_CLI_VERSION/cilium-darwin-$CLI_ARCH.tar.gz
sudo tar xzvfC cilium-darwin-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-darwin-${CLI_ARCH}.tar.gz
```

## Récupérer et installer le fichier kubeconfig

L'animateur vous *fournit* le lien de téléchargement du fichier kubeconfig.
Enregistrez-le dans votre répertoire "home" sous le nom `.kube/config`

## Vérifier que l'accès `kubectl` fonctionne

```bash
kubectl cluster-info
```

Ce qui doit donner :

```
Kubernetes control plane is running at https://xxxxxxxx
CoreDNS is running at https://xxxxxx/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
```

Pour note, une *cheat-sheet* des commandes kubectl est disponible [ici](https://kubernetes.io/fr/docs/reference/kubectl/cheatsheet/)

Vérifier que les Workers Nodes sont biens vus :
```bash
kubectl get nodes -o wide
```

Notez :
* leurs IP publiques et privées
* la version du container runtime
* la version du kernel sous-jaçent

Pourquoi ne voit-on pas les Master Nodes ?

## Accès aux Nodes

### Depuis une station Linux

Installer  `nsenter` qui permet de se connecter dans les Nodes via un pod privilégié :
```bash
git clone https://github.com/alexei-led/nsenter.git
cd nsenter
./nsenter-node.sh <nom du node>
```

Une fois connecté dans un des Nodes, installer `tcpdump` qui servira par la suite :

```bash
apt-get update && apt-get install -y tcpdump
```

### Depuis une station Windows

Nous avons légèrement modifié le script nsenter pour qu'il fonctionne sous Windows.

Télécharger `nsenter` en suivant [ce lien](https://raw.githubusercontent.com/srnfr/TP-CNI/main/tools/nsenter-windows.ps1). Vous pouvez copier/coller ce contenu dans un fichier .ps1 par exemple : `C:\Users\$env:UserName\Downloads\nsenter-windows.ps1`.

Lancez ensuite le script :

```shell
C:\Users\$env:UserName\Downloads\nsenter-windows.ps1 <nom du node>
```

## Statut de Cilium CNI dans le cluster

Dans ce setup, Cilium est déjà installé comme CNI.

```shell
cilium version
```

```shell
cilium status
```

Lancez un test de connectivité pour vérifier que Cilium fonctionne à 100% :
```shell
cilium connectivity test
```

## Créer un compte GitHub et GitPod

[Github](https://github.com) fait office de SSO pour tout l'ecosysteme Cloud Native.

[Gitpod](https://gitpod.com) est un IDE en ligne qui permet de travailler sur des projets sans avoir à installer quoi que ce soit sur son poste.

Une fois votre compte Github obtenu, vous pouvez vous connecter à Gitpod avec votre compte Github. Dans le plan Free, vous aurez accès à 50 heures de travail par mois ce qui suffira pour ce cours, à partir du moment où vous détruisez votre environnement le soir (s'il n'est pas mis en hubernation par Gitpod automatiquement)

## [OPTIONNEL] Installer `stern` (sur Linux)

L'outil `stern` permet de facilement consulter les logs de plusieurs pods en même temps.
Le code est disponible sous [https://github.com/stern/stern](https://github.com/stern/stern).
Il est possible d'obtenir le même résultat en jonglant avec des kubectl `logs`

---

[Revenir au sommaire](../README.md) | [TP Suivant](./TP02.md)
