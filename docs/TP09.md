# Métriques réseau

## Environnement
Cette fois nous nous connecterons en SSH sur une VM spéciale dont les infos et mdp vous seront fournis par l'animateur.

Dans cette VM un cluster KinD (Kubernetes in DOcker) est déjà installé et configuré.

Nous utilisons ce setup car il nous donne plus de liberté en terme de réseau et d'installation packagée de Cilium (chez DO, Hubble est désactivé).

Nettoyons les eventuels clusters déjà présents :
```shell
cd /mnt/cilium_lab/basic
./clean-kind.sh 
```

Lançons un cluster *sans* CNI :
```shell
./01-install-cluster.sh
```


## Export Prometheus Cilium & Hubble

Installons le CNI
```shell
helm upgrade --install --namespace kube-system --repo https://helm.cilium.io cilium cilium --version 1.12.1 --values ebpf-values.yaml
```
Les values que nous utilisons pour ce chart Helm activent l'export Prometheus :
```yaml
prometheus:
  enabled: true
hubble:
  enabled: true
  metrics:
    enabled:
       - drop
       - tcp
       - flow
       - icmp
       - http
```

Vérifions que le cluster est bien opérationnel au bout de plusieurs minutes :
```shell
kubectl get nodes
```
```shell
cilium status
```

## Export Prometheus Cilium & Hubble

Nous allons installer un stack de monitoring Prometheus+Grafana

```shell
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.12/examples/kubernetes/addons/prometheus/monitoring-example.yaml
```

Puis

```shell
kubectl -n cilium-monitoring port-forward service/grafana --address 0.0.0.0 --address :: 3000:3000
```

Il ne reste plus qu'à visiter http://127.0.0.1:3000 pour consulter les statistiques issues de Cilium et de Hubble !

---
[Revenir au sommaire](../README.md) | [TP Suivant](./TP10.md)
