# Preservation de l'IP source

Ce TP se déroule sur votre Cluster DigitalOcean

## Deployer l'application Guestbook déjà vu précedemment (i.e TP10)
Utilisez un replica du frontend à 1 pour plus de simplicité.

## Depuis l'interieur du Cluster
Depuis un Pod "debug-blue", tester l'acces au frontend de l'application Guestbook
Observez les logs de l'application pour identifier l'IP source

```bash
kubecl logs -f frontend-xxxx 
```

## Depuis l'exterieur
Depuis l'extérieur (votre PC ou Github), consultez le site plusieurs fois.
Vous constatez dans les logs que l'IP vue depuis le frontend est changeante.

## Modifier le `externalTrafficPolicy=Local`

Modifier le service d'exposition du Frontend afin que le champ `externalTrafficPolicy` soit à `Local` (et non `Cluster` comme par défaut) :
    
    ```bash
    kubectl patch svc frontend -p '{"spec":{"externalTrafficPolicy":"Local"}}'
    ```
De nouveau, consultez le site depuis l'extérieur, et constatez que l'IP source est maintenant stable et correspond bien à l'IP publique du visiteur.

Augmentez le nombre de replicas du frontend à 3, et constatez que l'IP source est toujours stable mais que la répartition n'est pas de 1/3 sur chaque noeud, plutot 2/3 sur un noeud et 1/3 sur l'autre.

Dans la description du service, trouvez quel est le port TCP qui permet de publier si un Pod est présent sur un Noeud.
Faites des requetes sur ce port sur les différentes et observez la page service.

[Revenir au sommaire](../README.md) | [TP Suivant](./TP12.md)